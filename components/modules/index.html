<!DOCTYPE html>
<html lang=en>
<meta charset=utf-8>
<style>
:root{box-sizing:border-box}
*,::before,::after{box-sizing:inherit}
body{font-size:calc(.5em + .4vw);font-family:TIMES NEW ROMAN;color:black;background:#bdc3c7}
button,select,input{font-size:calc(.5em + .4vw);text-align:center;background:#d8d8d8;border-left:1px solid#ddd;border-right:1px solid#ddd;border-color:#d8d8d8}
button{font-weight:bold}
.s1b{height:49vh;overflow:auto;text-align:center}
.scr{overflow:auto}
.scr thead{position:sticky;top:0;z-index:1}
.scr th,.fix th,.tab thead th{font-weight:bold;text-align:center;background:#d8d8d8;border:1px solid#ddd}
nav li a{float:left;padding:10px 25px 10px 25px;color:#fff}
nav li a:hover{background:#2C3E50}
nav li ul{display:none}
nav li:hover ul{display:inline}
nav li li{float:none;line-height:1.5;margin-left:10px;}
nav .dd{position:relative}
nav .dd ul{position:absolute;z-index:100;left:0;top:100%;background:#fff;padding:20px 0;border-bottom:3px solid #34495e}
nav .dd li{white-space:nowrap}
nav .dd li a{padding:10px 35px;min-width:200px}
nav li li button{font-family:TIMES NEW ROMAN;background:transparent;
padding-left:10px;text-align:left;border:none;font-weight:normal;cursor:pointer;min-width:150px}
nav li li input{padding-left:10px;background:transparent;font-weight:normal;cursor:pointer;color:black}
.id{font-weight:bold;text-align:center}
.bc{padding:0.5rem 0.7rem;background:#eee}
.modal{display:flex;flex-direction:column;justify-content:center;gap:0.4rem;width:450px;padding:1.3rem;min-height:250px;
position:absolute;z-index:2;top:20%;left:30%;background-color:white;border:1px solid #ddd;border-radius:15px}
.modal .flex{display:flex;align-items:center;justify-content:space-between}
.hidden{display:none}
th{background:white;position:sticky;top:0}
.cl1{float:left;width:100%;margin:2px;margin-top:2px;margin-bottom:2px}
.cl02{float:left;width:100%;text-align:center;margin-top:2px;margin-bottom:2px}
.cont{display:grid;grid-template-areas:"nav nav""pbar pbar""rec cfg""rec cfg""tit tit";
grid-template-columns:85% 15%;grid-gap:0;margin:0}
header{grid-area:tit}
.tit{margin:0}
nav{grid-area:nav}
.site-nav{display:flex;margin:0;padding:.5em;background-color:#5f4b44;list-style-type:none;border-radius:.2em}
.site-nav>li{margin-top:0}
.site-nav>li>a{display:block;padding:.5em 1em;background-color:#cc6b5a;color:white;text-decoration:none}
.site-nav>li+li{margin-left: 1.5em}
.site-nav>.nav-right{margin-left:auto}
.rec{grid-area:rec;height:90vh}
.cfg{grid-area:cfg;height:90vh}
.pbar{grid-area:pbar}
</style>
<script>
pc=dp=up=0
function CL(){
	d=new Date();h=d.getHours();m=d.getMinutes();s=d.getSeconds();if(h<10)h="0"+h
	if(m<10)m="0"+m;if(s<10)s="0"+s;document.getElementById("cDT").innerHTML=h+":"+m+":"+s
	setTimeout("CL()",1000);if(up){pbs(pc);pc=pc+dp;if(pc>100){pc=up=0;rF()}}}
</script>
<section class="modal hidden">
	<div class=flex>
		<h></h>
		<button class=bc onclick=cM()>⨉
	</div>
	<div class=s1b><table id=tArc width=100%>
		<thead>
			<tr><th width=10%>#
			<th width=30%>Date
			<th width=30%>Time
			<th width=30%>Event
		<tbody id=tB>
	</table></div>	
</section>
<title>MB-IEC104</title>
<body onload=init()><form method=post name=form target=hidden_frame> 
<div class=cont>
	<pbar class=pbar><div id=vPB style=display:none>
		<div class=cl1><progress class=cl02 id=oPB max=100 value=0></progress>
	</div></div></pbar>
	<div class="cfg scr"><table border=1px>
		<thead><tr position=sticky><th>RTU/ASCII [s]
			<th><input type=radio class=chR name=mT id=mbS checked>
		<tr><th>Eth TCP [e]
			<th><input type=radio class=chR name=mT id=mbE>
		<tr><th>Channel
			<th><select id=idx onchange=ch_id()>
			<option id=M_0 value=0>#1
			<option id=M_1 value=1>#2
			<option id=M_2 value=2 disabled=true>#3
			<option id=M_3 value=3 disabled=true>#4
			<option id=M_4 value=4 disabled=true>#5
			<option id=M_5 value=5 disabled=true>#6
			<option id=M_6 value=6 disabled=true>#7
			<option id=M_7 value=7 disabled=true>#8
		</thead>
		<tbody><tr><th colspan=2>Common Properties
		<tr><td>Initial Delay, ms
			<td><input type=number size=6 step=1 min=0 max=30000 name=mbInDel onchange=ch_num(this)>
		<tr><td>MB Fault Set, ms
			<td><input type=number size=6 step=1 min=100 max=65535 name=tFault onchange=ch_num(this)>
		<tr><td>Between Poll, ms
			<td><input type=number size=6 step=1 min=10 max=65535 name=tBetw onchange=ch_num(this)>
		<tr><td>IEC Sync Time, min
			<td><input type=number size=6 step=1 min=0 max=65535 name=tSync onchange=ch_num(this)>
		<tr><td>IEC Swith 104/101, sec
			<td><input type=number size=6 step=1 min=0 max=65535 name=tSwith onchange=ch_num(this)>
		<tr><th colspan=2>ModBus TCP/IP Client
		<tr><td>Channel
			<td><select id=cnN onchange=ch_cn()>
			<option value=0>CH# 1
			<option value=1>CH# 2
			<option value=2>CH# 3
			<option value=3>CH# 4
			<option value=4>CH# 5
			<option value=5>CH# 6
			<option value=6>CH# 7
			<option value=7>CH# 8
		<tr><td>IP Address
			<td><input type=text size=12 maxlength=15 id=eAdr onkeypress="return is_ip(this,event)"onchange=eIp()>
		<tr><td>Port
			<td><input type=number size=5 step=1 min=0 max=9999 id=ePort onchange=chP(this)>
		<tr><td>Max. Retry
			<td><input type=number size=2 step=1 min=0 max=5 name=eRetry onchange=ch_num(this)>
		<tr><td>Responce Timeout
			<td><input type=number size=6 step=1 min=10 max=60000 name=eRespT onchange=ch_num(this)>
		<tr><th colspan=2>ModBus Serial Master
		<tr><td>Channel
			<td><select id=cnS onchange=ch_cs()>
			<option value=0>CH# 1
			<option value=1>CH# 2
		<tr><td>Mode
			<td><select id=mbM onchange=cmM()>
				<option value=0>RTU
				<option value=1>ASCII
		<tr><td>Baud Rate
			<td><select id=mbB onchange=cmB()>
				<option value=0>1200
				<option value=1>2400
				<option value=2>4800
				<option value=3>9600
				<option value=4>19200
				<option value=5>38400
				<option value=6>57600
				<option value=7 selected=selected>115200
				<option value=8>128000
				<option value=9>230400
				<option value=10>256000
				<option value=11>460800
				<option value=12>921600
		<tr><td>Parity
			<td><select id=mbP onchange=cmP()>
				<option value=0>None
				<option value=1>Odd
				<option value=2>Even
		<tr><td>Stop Bits
			<td><select id=mbS onchange=cmS()>
				<option value=0>1
				<option value=1>2
				<option value=2>1.5
		<tr><td>Data Bits
			<td><select id=mbD onchange=cmD()>
				<option value=0>7
				<option value=1 selected=selected>8
		<tr><td>Max. Retry
			<td><input type=number size=2 step=1 min=0 max=5 name=mbRetry onchange=ch_num(this)>
		<tr><td>Responce Timeout
			<td><input type=number size=6 step=1 min=10 max=60000 name=mbRespT onchange=ch_num(this)>
		<tr><th colspan=2>IEC 60870-5-104 Server
		<tr><td>Timeout 0
			<td><input type=number size=2 step=1 min=1 max=255 name=t0 onchange=ch_num(this)>
		<tr><td>Timeout 1
			<td><input type=number size=2 step=1 min=1 max=3000 name=t1 onchange=ch_num(this)>
		<tr><td>Timeout 2
			<td><input type=number size=2 step=1 min=1 max=3000 name=t2 onchange=ch_num(this)>
		<tr><td>Timeout 3
			<td><input type=number size=2 step=1 min=1 max=65535 name=t3 onchange=ch_num(this)>
		<tr><td>K Param.
			<td><input type=number size=4 step=1 min=1 max=48 name=K onchange=ch_num(this)>
		<tr><td>W Param.
			<td><input type=number size=4 step=1 min=1 max=32 name=W onchange=ch_num(this)>
		<tr><td>IP Address
			<td><input type=text size=12 maxlength=15 id=Aip name=ipAdr onkeypress="return is_ip(this,event)">
		<tr><td>Port
			<td><input type=number size=5 step=1 min=1024 max=60000 name=tcpPort onchange=ch_num(this)>
		<tr><th colspan=2>IEC 60870-5-101 Slave
		<tr><td>Baud Rate
			<td><select name=Baud>
				<option value=0>1200
				<option value=1>2400
				<option value=2>4800
				<option value=3>9600
				<option value=4>19200
				<option value=5>38400
				<option value=6>57600
				<option value=7 selected=selected>115200
		<tr><td>Parity
			<td><select name=Parity>
				<option value=0>None
				<option value=1 selected=selected>Odd
				<option value=2>Even
		<tr><td>Stop Bits
			<td><select name=stopBits>
				<option value=0>1
				<option value=1>2
				<option value=2>1.5
		<tr><td>Data Bits
			<td><select name=dataBits>
				<option value=0>7
				<option value=1 selected=selected>8
		<tr><td>Link Layer Retries
			<td><input type=number size=3 step=1 min=0 max=254 name=chRetry onchange=ch_num(this)>
		<tr><td>Timeout Frames Rx
			<td><input type=number size=2 step=1 min=0 max=99 name=tRx onchange=ch_num(this)>
		<tr><td>Link Layer Mode
			<td><select name=llMode>
				<option value=0>Unbalan.
				<option value=1>Balanced
		<tr><td>Link Addr. Size
			<td><select name=llAdrSize onchange=ch_adr(document.form.llAdr,this)>
				<option value=0>1
				<option value=1 selected=selected>2
		<tr><td>Link Address
			<td><input type=number size=5 step=1 min=0 max=65534 name=llAdr onchange=ch_adr(this,document.form.llAdrSize)>
		<tr><td>Timeout ACK,ms
			<td><input type=number size=5 step=1 min=0 max=99999 name=tAck onchange=ch_num(this)>
		<tr><td>Timeout Repead,ms
			<td><input type=number size=5 step=1 min=0 max=99999 name=tRep onchange=ch_num(this)>
		<tr><td>Single Char ACK
			<td><select name=usACK>
				<option value=0>Disable
				<option value=1>Enable
		<tr><th colspan=2>IEC 60870-5 Applic. Layer
		<tr><td>ASDU Addr. Size
			<td><select name=alAdrSize onchange=ch_adr(document.form.AsduAdr,this)>
				<option value=0>1
				<option value=1 selected=selected>2
		<tr><td>ASDU Address
			<td><input type=number size=5 step=1 min=1 max=65534 name=AsduAdr onchange=ch_adr(this,document.form.alAdrSize)>
		<tr><td>Originator Address
			<td><input type=number size=2 step=1 min=0 max=255 name=orgAdr onchange=ch_num(this)>
		<tr><td>IOA Size
			<td><select name=ioaSize>
				<option value=0>1
				<option value=1>2
				<option value=2 selected=selected>3
		<tr><td>COT Size
			<td><select name=cotSize>
				<option value=0>1
				<option value=1 selected=selected>2
		<tr><td>Point Status Timeout
			<td><input type=number size=5 step=1 min=0 max=3600 name=tPSt onchange=ch_num(this)>
		<tr><td>Active Termination
			<td><select name=actTerm>
				<option value=0>Disable All
				<option value=1>Enable CMD
				<option value=2>Enable CSE
				<option value=3>Enable All
		<tr><td>Select Time Out
			<td><input type=number size=5 step=1 min=0 max=600 name=tSel onchange=ch_num(this)>
		<tr><td>Interr. Time Stamp
			<td><select name=tIrr>
				<option value=0>NONE
				<option value=1>24 BITS
				<option value=2>56 BITS
		<tr><td>Events Time Stamp
			<td><select name=tEvt>
				<option value=0>NONE
				<option value=1>24 BITS
				<option value=2>56 BITS
		<tr><td>Cyclic Time Stamp
			<td><select name=tMval>
				<option value=0>NONE
				<option value=1>24 BITS
				<option value=2>56 BITS
		<tr><td>Spontaneous Feature
			<td><select name=spVal>
				<option value=0>Disable
				<option value=1 selected=selected>Enable
		<tr><td>Cycle of Normaliz. s
			<td><input type=number size=8 step=1 min=0 max=2073600 name=tNorm onchange=ch_num(this)>
		<tr><td>Cycle of Scaled, s
			<td><input type=number size=8 step=1 min=0 max=2073600 name=tScal onchange=ch_num(this)>
		<tr><td>Cycle of Floating, s
			<td><input type=number size=8 step=1 min=0 max=2073600 name=tFloat onchange=ch_num(this)>
	</table></div>
	<div class="rec scr"><table id=btCfg border=1px>
		<thead><tr><th width=5%><button type=button onclick=srt(7)>Slave ID
			<th width=8%>Function
			<th width=6%>Address
			<th width=7%>Endian Swap
			<th width=8%>Poll Interval, ms
			<th width=12%>Object Type
			<th width=7%><input type=checkbox id=Thr>  Threshold
			<th width=7%><input type=checkbox id=LoL>  Low Limit
			<th width=7%><input type=checkbox id=HiL>  High Limit
			<th width=7%><input type=checkbox id=Flt>  Fault Value
			<th width=7%><input type=checkbox id=Sto>  St.Timeout, s
			<th width=6%><button type=button onclick=srt(5)>IOA Start
			<th width=6%>Range of IOA
			<th width=6%>Interrog.
			<th><button type=button onclick=del_str()>-
		<tr><th><input id=devID type=number size=3 step=1 min=1 max=247 value=1 onchange=ch_num(this)>
			<th><select id=regType value=0 onchange=ch_r()>
				<option value=0>[rw] Coil Status
				<option value=1>[ro] Coil Status
				<option value=2>[wo] Coil Status
				<option value=3>[ro] Input Status
				<option value=4>[rw Holding Reg.
				<option value=5>[ro] Holding Reg.
				<option value=6>[wo] Holding Reg.
				<option value=7>[ro] Input Reg.
			<th><input id=regNum type=number size=5 step=1 min=0 max=499999 value=0 onchange=ch_num(this)>
			<th><select id=eSwap>
				<option value=0>Don't need
				<option value=1>Byte swap
				<option value=2>Word swap
				<option value=3>Byte and Word
			<th><input id=pInt type=number size=8 step=1 min=100 max=1200000 value=1000 onchange=ch_num(this)>
			<th><select id=iecType onchange=ch_t()>
				<option id=B_0 value=0>Single point
				<option id=B_1 value=1>Double point
				<option id=R_2 value=2>Step position
				<option id=R_3 value=3>Normalized Measured value
				<option id=R_4 value=4>Scaled Measured value
				<option id=R_5 value=5>Floating Measured value
				<option id=R_6 value=6>Integrated totals
				<option id=R_7 value=7>Bitstring of 32 bit
			<th><input id=unSens type=number size=8 step=0.001 min=0 max=100000000 value=0.1 onchange=ch_num(this)>
			<th><input id=vLow type=number size=8 step=0.001 min=-99999999 max=100000000 value=0.1 onchange="ch_num(this)">
			<th><input id=vHi type=number size=8 step=0.001 min=-99999999 max=100000000 value=0.1 onchange=ch_num(this)>
			<th><input id=vFlt type=number size=8 step=0.001 min=-99999999 max=100000000 value=0.0 onchange=ch_num(this)>
			<th><input id=tSt type=number size=6 step=1 min=5 max=3600 value=60 onchange=ch_num(this)>
			<th><input id=oAddr type=number size=5 step=1 min=1 max=65535 value=1 onchange=ch_num(this)>
			<th><input id="oNum"type=number size=4 step=1 min=1 max=123 value=1 onchange=ch_num(this)>
			<th><select id=iGr>
				<option value=0>Global
				<option value=1>Group 1
				<option value=2>Group 2
				<option value=3>Group 3
				<option value=4>Group 4
				<option id=G_5 value=5>Group 5
				<option id=G_6 value=6>Group 6
				<option id=G_7 value=7>Group 7
				<option id=G_8 value=8>Group 8
				<option id=G_9 value=9>Group 9
				<option id=G_10 value=10>Group 10
				<option id=G_11 value=11>Group 11
				<option id=G_12 value=12>Group 12
				<option id=G_13 value=13>Group 13
				<option id=G_14 value=14>Group 14
				<option id=G_15 value=15>Group 15
				<option id=G_16 value=16>Group 16
			<th><button type=button onclick=add_str()>+
	</thead></table></div>
	<header>
		<h3 class=tit><<= MODBUS ~ IEC-60870-5-104/101 Gateway Configurator =>></h3>
	</header>
	<nav><ul class="site-nav">
		<li class=dd><a>FILE
			<ul><li><input type=file accept=.GTW id=selCfg></input>
			<li><button type=submit id=dCfg>Default Config</button>
			<li><button type=button onclick=wC()>Save to File</button>
			<li><button type=submit id=sEE>Save to Device</button></ul>
		<li class=dd><a>ARCHIVE
			<ul><li><button type=button onclick=oM()>View Events</button>
			<li><button type=submit id=clrA>Clear Archive</button></ul>
		<li class=dd><a>SERVICE
			<ul><li><button disabled=true>Select new FW file...</button>
			<li><input type=file accept=.BIN id=selFw placeholder="select file"onchange=rdFw(this)></input>
			<li><button type=submit id=rbFW>Roll Back FW</button>
			<li><button type=submit id=fcFW>Factory FW Load</button>
			<li><button type=submit id=Rst>Reset Device</button>
			<li><button type=submit id=SerN disabled=true>Save Serial</button></ul>
		<li><a>VER.<input type=number size=8 step=0.01 class=id name=VerFW id=ver disabled=true>
		<li><a>S/N <input type=number size=8 step=1 min=1 max=65535 class=id name=SerN id=dev onchange=ch_num(this) disabled=true>
		<li class="nav-right"><button type=submit id=cDT><script>CL()</script></button>
	</nav></div>
</body>
<script>
const cMax=100000000,cMin=-99999999
const MaxOff=100000008,MinOff=-100000000
function $(s){return document.querySelector(s)}
function jp(s){return JSON.parse(s)}
function js(s){return JSON.stringify(s)}
function nv(s){return Number($(s).value)}
function sv(d,v){$(d).value=v}
function pbv(v){$('#vPB').style.display=v?"block":"none"}
function pbm(m){$('#oPB').max=m}
function pbs(s){sv('#oPB',s)}
function pbt(t){up=1;dp=100/t;pbm(100);pbv(1)}
const mT=document.querySelectorAll('.chR')
const gV=(e)=>{s='#cnN';d=0;id=e.target.id
	if(id=="mbS"){SS=0;s='#cnS';d=1}else{SS=1}
	$('#M_2').disabled=$('#M_3').disabled=$('#M_4').disabled=
	$('#M_5').disabled=$('#M_6').disabled=$('#M_7').disabled=d;sv('#idx',nv(s))}
mT.forEach(match=>{match.addEventListener('change',gV)})
$("#selCfg").onchange=function(){
	const fr=new FileReader()
	fr.onload=function(){
		c=jp(this.result);CfgA=jp(c['CfgA'])
		document.querySelectorAll('input,select').forEach(el=>{
		if(el.name!="")el.value=c[el.name]});sIP('#Aip')
		for(i=0;i<8;i++){iP[i]=c['iP'+i];eP[i]=c['eP'+i]}ch_cn()
		for(i=0;i<2;i++){sM[i]=c['mbM'+i];sB[i]=c['mbB'+i];sP[i]=c['mbP'+i]
			sS[i]=c['mbS'+i];sD[i]=c['mbD'+i]}ch_cs();show_cfg()}
	fr.readAsText(this.files[0])}
dev,ver
host=document.location.origin
var oDt,pLen,oSt=0
ws="ws://"+`${document.location.host}/ws`
var soc=new WebSocket(ws);soc.binaryType="arraybuffer"
soc.onerror=soc.onclose=function(){rF()}
soc.onmessage=function(ev){rdWS(ev.data)}
function rdFw(inp){
	const rd=new FileReader()
	f=inp.files[0];vnew=Number(f.name.slice(12,16))
	if(f.name.slice(0,12)=="MB_IEC_GTW_v"&&vnew>ver){
		if(!confirm("Ver."+vnew+" avaliable. Upload?"))return
	}else{alert("FW File Not Correct!");return}
	$('#selFw').disabled=true;rd.readAsArrayBuffer(f);inp.value=null
	rd.onload=function(){oDt=new Uint8Array(rd.result);ol=oDt.byteLength
		if(ol&&!oSt){pbv(1);pbm(ol);soc.send(js({name:"oSz",value:ol}));oSt=1
		}else{oSt=0;soc.send(js({name:"oCnl",value:"1"}))}}}
function rdWS(dt){
	try{obj=jp(dt);ov=obj.value;dl=oDt.byteLength
	switch(obj.name){case"pLen":pLen=ov;pbv(1);break
	case"pGet":pbs(ov);soc.send(oDt.subarray(ov,ov+pLen));break
	case"oEnd":soc.send(js({name:"oRes",value:"1"}));pbt(5);break
	case"oErr":case"oCnl":oSt=0;pbs(dl)}}
	catch{console.log(dt)}}
const md=$(".modal")
cM=function(){md.classList.add("hidden");show_cfg()}
eS=["Reset reason can not be determined","Reset due to power-on event","Reset by external pin",
"Software reset via esp_restart","Software reset due to exception/panic","Reset due to interrupt watchdog",
"Reset due to task watchdog","Reset due to other watchdogs","Reset after exiting deep sleep mode",
"Brownout reset","Reset over SDIO","Reset by USB peripheral","Reset by JTAG","Reset due to efuse error",
"Reset due to power glitch detected","Reset due to CPU lock up","Change to Reserved IEC Channel",
"Firmware update","Write Configuration data","Reset Command from Browser","Load Serial in Work Mode",
"Clear System Events Archive","Firmware roll back","Firmware reset to Factory","Reset to Default Configuration"]
oM=function(){
	md.classList.remove("hidden")
	ArcT.sort((function(){return function(a, b){x=Number(a[0]);y=Number(b[0]);return (x==y?0:(x>y?-1:1))}})())
	$('#tB').outerHTML="";c='<tbody id="tB">'
	for(i=0,n=0;i<ArcT.length;i++){
		u=Number(ArcT[i][0]);v=Number(ArcT[i][1]);if(!u&&!v)continue
		n++;dt=new Date(u*1000);d=dt.toDateString();t=dt.toTimeString();e=""
		if(v>15)v=(v>>4)+15;if(v>=eS.length)e="Error Event Value";else e=eS[v]
		c+='<tr bgcolor="#dbdfe4"id="rw'+n+'"><td>&nbsp;'+n+'<td>&nbsp;'+d+'<td>&nbsp;'+t+'<td>&nbsp;'+e
	}
	c+='</tbody>';$('#tArc').insertAdjacentHTML("beforeend",c)}
function ch_pV(){$('#pS').type=$('#pV').checked?"text":"password"}
ArcT=[],iP=[],eP=[],sM=[],sB=[],sP=[],sS=[],sD=[]
function ch_num(o){
	if(o.value==""){alert("Числовое поле содержит ошибку!");o.value=o.min;o.focus();o.select();return}
	n=Number(o.value);
	if(n>o.max||n<o.min){alert(o.value+" - недопустимое значение!\n выбор из диапазона: "
	+o.min+"..."+o.max);o.value=o.min;o.focus();o.select();return false}return true}
function ch_cn(){n=nv('#cnN');sv('#ePort',eP[n]);v=iP[n];s=""
	for(i=0;;){s+=(v>>i)&255;i+=8;if(i==32)break;s+='.'}sv('#eAdr',s)}
function ch_cs(){n=nv('#cnS');sv('#mbM',sM[n]);sv('#mbB',sB[n]);sv('#mbP',sP[n]);sv('#mbS',sS[n]);sv('#mbD',sD[n])}
function ch_id(){i=nv('#idx');if(!SS){sv('#cnS',i);ch_cs()}else{sv('#cnN',i);ch_cn()}}
function eIp(){
	n=nv('#cnN');o=document.form.eAdr
	ip=new RegExp("(^([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3})$)","g")
	p=o.value.split(".")
	if(!ip.test(o.value)||p[0]==0||p[0]>255||p[1]>255||p[2]>255||p[3]>255)
		{alert(o.value+" - недопустимый IP-адрес!");o.focus();o.select();return false}
	iP[n]=0;for(i=0;i<4;i++){iP[n]<<=8;iP[n]+=Number(p[3-i])}return true}
function chP(o){if(ch_num(o)){n=nv('#cnN');eP[n]=nv('#ePort')}}
function cmM(){n=nv('#cnS');sM[n]=nv('#mbM')};function cmB(){n=nv('#cnS');sB[n]=nv('#mbB')}
function cmP(){n=nv('#cnS');sP[n]=nv('#mbP')};function cmS(){n=nv('#cnS');sS[n]=nv('#mbS')}
function cmD(){n=nv('#cnS');sD[n]=nv('#mbD')}
function is_ckey(e){
	if(e.which===0&&(e.keyCode==35||e.keyCode==36||e.keyCode==37
		||e.keyCode==39||e.keyCode==45||e.keyCode==46))return true
	if(e.keyCode==8||e.keyCode==9||e.keyCode==27)return true;return false}
function sIP(ip){n=nv(ip);s="";for(i=0;;){s+=(n>>i)&255;i+=8;if(i==32)break;s+='.'}sv(ip,s)}
var nIP
function vIP(o){
	ip=new RegExp("(^([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3})$)","g")
	p=o.value.split(".")
	if(!ip.test(o.value)||p[0]==0||p[0]>255||p[1]>255||p[2]>255||p[3]>255)
		{alert(o.value+" - недопустимый IP-адрес!");o.focus();o.select();return 0}
	n=0;for(i=0;i<4;i++){n<<=8;n+=Number(p[3-i])}return n}
function is_ip(o,e){
	e=e||event;if(is_ckey(e))return true;k=e.keyCode?e.keyCode:e.which;if(k==0)return true;if(o.value.length>=16)return false
	if(k>47&&k<58){for(j=i=0;i<o.value.length;i++)if(o.value.charAt(i)=='.')j++
		if((j<3&&i>=3)&&(o.value.charAt(i-3)!='.'&&o.value.charAt(i-2)!='.'&&o.value.charAt(i-1)!='.'))o.value=o.value+'.'
		return true
	}else if(k==46){for(j=i=0;i<o.value.length;i++)if(o.value.charAt(i)=='.')j++
		if(o.value.charAt(i-1)=='.'||j==3)return false;return true
	}return false}
var CfgA=[]
function lcalc(a){
	t=a[3];n=a[9]
	if(a[1]>3){l=1;if(t>4)l=2;l*=n}else l=n/8+n%8>0;return l}
function inter(n,o,l,s){return (n<o&&l>o-n)||(n>o&&s>n-o)||(n==o)}
function ch_adr(a,s){if(!Number(s.value))a.max=255;else a.max=65534;ch_num(a)}
function srt(n){CfgA.sort((function(){return function(a,b){x=Number(a[n]);y=Number(b[n]);return x==y?0:(x<y?-1:1)}})());show_cfg()}
const tMax=64
const dMax=tMax*246
DN=0;SS=0
function add_str(){
	a=[]
	a[0]=nv('#regNum')
	a[1]=nv('#regType')
	a[2]=nv('#iecType')
	a[3]=nv('#eSwap')
	a[4]=$('#Thr').checked?$('#unSens').value:"0";a[4]=Number(a[4])
	a[5]=nv('#oAddr')
	a[6]=$('#HiL').checked?$('#vHi').value:MaxOff;a[6]=Number(a[6])
	a[7]=nv('#devID');if(SS)a[7]+=4096
	a[8]=$('#LoL').checked?$('#vLow').value:MinOff;a[8]=Number(a[8])
	a[9]=nv('#oNum')
	a[10]=nv('#pInt')
	a[11]=$('#Flt').checked?$('#vFlt').value:MaxOff;a[11]=Number(a[11])
	a[12]=$('#Sto').checked?$('#tSt').value:0;a[12]=Number(a[12])
	a[13]=nv('#iGr')
	oL=8;
	if(a[1]<2)oL=a[9]/8+(a[9]%8>0)
	else{if(a[3]<8)oL=2;else if(a[3]<20)oL=4;oL*=a[9]}
	DN+=oL;new_str(a)}
function new_str(a){
	if(CfgA.length>tMax){alert("Превышение количества записей таблицы!");return}
	if(DN>dMax){alert("Превышение размера хранилища объектов!");return}
	if(a[8]>=a[6]){alert("Ошибка перекрытия значений пределов!");return}
	l=lcalc(a)
	a[7]+=nv("#idx")*256
	soc=0;id=[];sa=a[7]&255
	for(i=0;i<CfgA.length;i++){
		a7=CfgA[i][7]
		if(a[7]==a7&&a[1]==CfgA[i][1]){
			if(inter(Number(a[0]),Number(CfgA[i][0]),l,lcalc(CfgA[i])))
				{alert('Регистр из диапазона занят!');return}}
		if(inter(a[5],Number(CfgA[i][5]),Number(a[9]),Number(CfgA[i][9])))
			{alert('Адрес объекта из диапазона занят!');return}
		if(a7>4095){
			a7&=255;j=0
			for(;j<id.length;j++){if(id[j]==a7)break}
			if(j==id.length||!id.length){id[j]=a7;soc++}
		}
	}
	if(soc>8){alert('Таблица TCP сокетов содержит ошибку!');return}
	if(SS){i=0;for(;i<id.length;i++){if(id[i]==sa)break}
	if(i==id.length)soc++
	if(soc>8){alert('Превышено количество TCP сокетов!');return}}
	CfgA.unshift(a);show_cfg()}
function del_str(){
	for(i=0;i<CfgA.length;){
		if(CfgA[i][14]==1){oL=8
			f=CfgA[i][1];n=CfgA[i][9];t=CfgA[i][3]
			if(f<2)oL=n/8+(n%8>0)
			else{if(t<8)oL=2;else if(t<20)oL=4;oL*=n}
			DN-=oL;CfgA.splice(i,1)
		}
		else i++}
	show_cfg()}
St=["Single point","Double point","Step position","Normalized Measured","Scaled Measured",
"Floating Measured","Integrated totals","Bitstring of 32 bit"]
Sr=["[rw] Coil Status","[ro] Coil Status","[wo] Coil Status","[ro] Input Status","[rw] Holding Reg.",
"[ro] Holding Reg.","[wo] Holding Reg.","[ro] Input Reg."]
Sw=["None swap","Byte swap","Word swap","Byte and Word"]
function show_cfg(){
	$('#tB').outerHTML="";c='<tbody id="tB">'
	for(i=0;i<CfgA.length;i++){
		on=CfgA[i][9];lo=CfgA[i][8];if(lo<cMin)lo="---";id=CfgA[i][7];ip=((id/256)&15)+1;if(id>4096){id-=4096;id&=255;id+="e["+ip+"]"}
		else{id&=255;id+="s["+ip+"]"}rn=CfgA[i][0];rt=CfgA[i][1];vt=CfgA[i][2];vf=CfgA[i][3];pi=CfgA[i][10];zn=CfgA[i][4]
		if(!zn)zn="---";rts=Sr[rt];vts=St[vt];vfs=Sw[vf];oa=CfgA[i][5];hi=CfgA[i][6];if(hi>cMax)hi="---";fv=CfgA[i][11]
		if(fv>cMax)fv="---";to=CfgA[i][12];if(!to)to="---";ig=CfgA[i][13];if(!ig)ig="Global";else ig="Group "+ig
		c+='<tr bgcolor=#dbdfe4 id=rw'+i+'><th>'+id+'<th>'+rts+'<th>'+rn+'<th>'+vfs+'<th>'+pi+'<th>'+vts+'<th>'+zn+'<th>'+lo+'<th>'+hi+
		'<th>'+fv+'<th>'+to+'<th>'+oa+'<th>'+on+'<th>'+ig+'<th><input type=checkbox value='+i+' onClick=ch_s(this,'+i+')>'
	}
	c+='</tbody>';$('#btCfg').insertAdjacentHTML("beforeend",c)}
function ch_t(){
	$('#iGr').value=$('#vFlt').value=0;$('#unSens').value=0.1
	if($('#iecType').value==3){$('#vFlt').max=$('#unSens').max=$('#vHi').max=$('#vLow').max=1.0
		$('#vFlt').min=$('#unSens').min=$('#vHi').min=$('#vLow').min=-1.0
		$('#vFlt').step=$('#unSens').step=$('#vHi').step=$('#vLow').step=0.00001}
	else{$('#vFlt').max=$('#unSens').max=$('#vHi').max=$('#vLow').max=cMax
		$('#unSens').min=0;$('#vFlt').min=$('#vHi').min=$('#vLow').min=cMin
		$('#vFlt').step=$('#unSens').step=$('#vHi').step=$('#vLow').step=0.001}
	gd=false;if($('#iecType').value==6)gd=true;$('#G_5').disabled=$('#G_6').disabled=$('#G_7').disabled=
	$('#G_8').disabled=$('#G_9').disabled=$('#G_10').disabled=$('#G_11').disabled=$('#G_12').disabled=
	$('#G_13').disabled=$('#G_14').disabled=$('#G_15').disabled=$('#G_16').disabled=gd}
function ch_s(o,i){CfgA[i][14]=(o.checked)?1:0;$("#rw"+i).style.background=(o.checked)?'grey':'#dbdfe4'}
function bd(b){$('#B_0').disabled=$('#B_1').disabled=b;$('#R_2').disabled=$('#R_3').disabled=$('#R_4').disabled=
	$('#R_5').disabled=$('#R_6').disabled=$('#R_7').disabled=!b;$('#iecType').value=b*2}
function ch_r(){
	$('#oNum').value=1
	if($('#regType').value<4){bd(0);$('#oNum').max=1968}
	else{bd(1);$('#oNum').max=123}}
function init(){sv('#regType',0);ch_r();show_cfg()}
function loadJson(url){return fetch(url).then(resp=>resp.json())}
async function ldTab(len){while(len--){
	await loadJson(`${host}/tbl_rd`).then(function(c){
	a=[];a=jp(js(c['CfgA']));CfgA.unshift(a)})}show_cfg()}
async function ldArc(){
	await loadJson(`${host}/arc_rd`).then(function(c){
	ArcT=jp(js(c['ArcT']))})}
document.addEventListener('DOMContentLoaded',function(e){
	form.onsubmit=async(e)=>{
		e.preventDefault();nIP=vIP(document.form.ipAdr)
		if(!nIP)return;id=e.submitter.id
		if(id=='sEE'){
			fd=new FormData(form)
			if (!confirm("Save Configuration in to Device?"))return
			fd.delete('mT');fd.delete('SerN');fd.delete('VerFW');fd.append('tLen',js(CfgA.length))
			fd.set('ipAdr',toInt(nIP));for(i=0;i<8;i++){fd.append('iP'+i,toInt(iP[i]));fd.append('eP'+i,eP[i])}
			for(i=0;i<2;i++){fd.append('mbB'+i,sB[i]);fd.append('mbP'+i,sP[i]);fd.append('mbS'+i,sS[i])
				fd.append('mbD'+i,sD[i]);fd.append('mbM'+i,sM[i])}
			resp=await fetch(`${host}/cfg_wr`,{method:'POST',body:js(Object.fromEntries(fd))})
			if(resp.status!==200)alert('Response Status: '+resp.status)
			i=CfgA.length
			while(i--){
				a=[];a=CfgA[i];tb=new FormData();tb.append('CfgA',js(a))
				resp=await fetch(`${host}/tbl_wr`,{method:'POST',body:js(Object.fromEntries(tb))})
				if(resp.status!==200)alert('Response Status: '+resp.status)
			}
		}else{
			fd=new FormData()
			if(id=='clrA'){
				if(!confirm("Clear Events Archive?"))return
				fd.append('clrA',js(1));pbt(3)
			}else if(id=='Rst'){
				if(!confirm("Reset Device?"))return
				fd.append('Res',js(1));pbt(2)
			}else if(id=='SerN'){
				if(!confirm("Save Serial Number?"))return
				fd.append('SerN',js(nv('#dev')));pbt(2)
			}else if(id=='cDT'){
				d=Math.round(Date.now()/1000);fd.append('cDT',js(d))
				if(dev==25000)$('#SerN').disabled=$('#dev').disabled=false
			}else if(id=='dCfg'){
				if(!confirm("Reset to Default Configuration?"))return
				fd.append('dCfg',js(1));pbt(2)
			}else if(id=='rbFW'){
				if(!confirm("Roll Back FirmWare?"))return
				fd.append('rbFW',js(1));pbt(4)
			}else if(id=='fcFW'){
				if(!confirm("Load Factory FirmWare?"))return
				fd.append('fcFW',js(1));pbt(15)
			}else return
			resp=await fetch(`${host}/cfg_wr`,{method:'POST',body:js(Object.fromEntries(fd))})
			if(resp.status!==200)alert('Response Status: '+resp.status)
		}
	}
	loadJson(`${host}/cfg_rd`).then(function(c){
		document.querySelectorAll('input,select').forEach(el=>{
			if(el.name!="")el.value=c[el.name]});nIP=nv('#Aip');sIP('#Aip')
			for(i=0;i<8;i++){iP[i]=Number(c['iP'+i]);eP[i]=c['eP'+i]}ch_cn()
			for(i=0;i<2;i++){sM[i]=c['mbM'+i];sB[i]=c['mbB'+i];sP[i]=c['mbP'+i]
				sS[i]=c['mbS'+i];sD[i]=c['mbD'+i]}ch_cs()
		CfgA.splice(0,CfgA.length);len=c['tLen'];if(len)ldTab(len)
		ArcT.splice(0,ArcT.length);ldArc();cM()
		dev=nv('#dev');ver=0.01*nv('#ver');sv('#ver',ver.toFixed(2))
	})})
document.addEventListener('keypress',function(){document.querySelectorAll('input').forEach(el=>{
	if(el.type==='number')el.onkeypress=function(event){c=(event.which)?event.which:event.keyCode
		if(c>31&&(c<45||c>57||c==47))return false;return true}
 	})})
function wC(){
	fd=new FormData(form);fd.append('tLen',js(CfgA.length));fd.set('ipAdr',toInt(nIP));fd.append('CfgA',js(CfgA))
	for(i=0;i<8;i++){fd.append('iP'+i,toInt(iP[i]));fd.append('eP'+i,eP[i])};fd.delete('mT')
	for(i=0;i<2;i++){fd.append('mbB'+i,sB[i]);fd.append('mbP'+i,sP[i]);fd.append('mbS'+i,sS[i])
		fd.append('mbD'+i,sD[i]);fd.append('mbM'+i,sM[i])}
	fw=new File([js(Object.fromEntries(fd))],$("#dev").value+".GTW",{type:"application/octet-stream"})
	window.location=(URL||webkitURL).createObjectURL(fw)}
function rF(){setTimeout(function(){location.reload()},1000)}
function toInt(n){if(n>2147483647)n-=4294967296;return n}
</script>